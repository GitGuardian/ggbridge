{{- $index := .index -}}
{{- $context := .context -}}
{{- $releaseNamespace := $context.Release.Namespace -}}
{{- $clusterDomain := $context.Values.clusterDomain -}}

{{- $fullname := ternary (include "ggbridge.server.fullname" $context) (include "ggbridge.client.fullname" $context) (eq $context.Values.mode "server") -}}
{{- $ports := $context.Values.proxy.service.ports -}}
{{- $logLevel := $context.Values.proxy.logLevel -}}
{{- $maxFails := $context.Values.proxy.config.upstream.maxFails | default 1 -}}
{{- $failTimeout := $context.Values.proxy.config.upstream.failTimeout | default "60s" -}}
{{- $healthLoadBalancing := $context.Values.proxy.config.upstream.healthLoadBalancing -}}
{{- $proxyTimeout := $context.Values.proxy.config.server.proxyTimeout | default "600s" -}}
{{- $proxyConnectTimeout := $context.Values.proxy.config.server.proxyConnectTimeout | default "10s" -}}
{{- $customDirectivesConfig := $context.Values.proxy.config.server.customDirectives | default list -}}

{{- $currentIndex := $index | int -}}

load_module "/usr/lib/nginx/modules/ngx_stream_module.so";

worker_processes 1;

error_log  stderr  {{ $logLevel }};
pid        /var/run/nginx.pid;

events {
    worker_connections 1024;
}

stream {
    log_format main '$remote_addr [$time_local] '
                    '$protocol $status $bytes_sent $bytes_received '
                    '$session_time "$upstream_addr" '
                    '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';

    access_log /dev/stdout main;

    resolver {{ printf "kube-dns.kube-system.svc.%s" $clusterDomain }} valid=30s;
    resolver_timeout 5s;

    {{ range $tunnel, $config := $ports }}
    upstream {{ $tunnel }} {
        {{- if and (eq $tunnel "health") (not $healthLoadBalancing) }}
          {{- /* Health sans load balancing : seulement le serveur courant */ -}}
          {{- $indexProxyFullname := printf "%s-proxy-%d" $fullname $currentIndex }}
          server {{ printf "%s.%s.svc.%s" $indexProxyFullname $releaseNamespace $clusterDomain }}:{{ $config.port }} max_fails={{ $maxFails }} fail_timeout={{ $failTimeout }};
        {{- else }}
          {{- /* Load balancing normal */ -}}
          {{- range $idx := until ($context.Values.deploymentCount | int) }}
            {{- $indexProxyFullname := printf "%s-proxy-%d" $fullname $idx }}
            {{- $weight := ternary 100 1 (eq $idx $currentIndex) }}
            server {{ printf "%s.%s.svc.%s" $indexProxyFullname $releaseNamespace $clusterDomain }}:{{ $config.port }} weight={{ $weight }} max_fails={{ $maxFails }} fail_timeout={{ $failTimeout }};
          {{- end }}
        {{- end }}
    }
    {{ end }}

    {{ range $tunnel, $config := $ports }}
    server {
        listen {{ $config.containerPort }};
        proxy_pass {{ $tunnel }};
        proxy_timeout {{ $proxyTimeout }};
        proxy_connect_timeout {{ $proxyConnectTimeout }};
        {{- range $customDirectivesConfig }}
          {{- $applyTo := .applyTo }}
          {{- $shouldApply := false }}
          {{- if kindIs "slice" $applyTo }}
            {{- if has $tunnel $applyTo }}
              {{- $shouldApply = true }}
            {{- end }}
          {{- end }}
          {{- if $shouldApply }}
            {{- range .directives }}
        {{ . }}
            {{- end }}
          {{- end }}
        {{- end }}
    }
    {{ end }}
}
