name: Unstable Release

on:
  push:
    branches:
      - 'main'
    tags-ignore:
      - '*'
    paths-ignore:
      - 'demo/**'
      - 'docs/**'
      - 'examples/**'
      - 'helm/ggbridge/README.md'
      - 'LICENSE'
      - 'README.md'
      - 'SECURITY.md'
  workflow_dispatch:
    inputs:
      runner:
        description: "Specify the runner to use"
        required: true
        default: "ubuntu-latest"

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  DAGGER_VERSION: '0.18.5'

jobs:
  build-packages:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64
    name: Build packages for ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set GitHub vars
        id: github
        uses: ./.github/actions/github

      - name: Write Melange Signing Key
        id: melange-signing-key
        shell: bash
        env:
          SIGNING_KEY_BASE64: ${{ secrets.MELANGE_SIGNING_KEY_BASE64 }}
        run: |
          mkdir -p ${{ runner.temp }}/packages
          echo -n "$SIGNING_KEY_BASE64" | base64 -d > ${{ runner.temp }}/packages/melange.rsa

      - name: Build packages
        id: apk
        uses: ./.github/actions/melange/build
        with:
          arch: ${{ steps.github.outputs.arch }}
          signing-key: ${{ runner.temp }}/packages/melange.rsa
          output-dir: ${{ runner.temp }}/packages
          dagger-version: ${{ env.DAGGER_VERSION }}
          dagger-cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ steps.github.outputs.arch }}
          path: ${{ runner.temp }}/packages/${{ steps.github.outputs.arch }}/
          retention-days: 1

  publish-images:
    strategy:
      matrix:
        include:
          - variant: prod
            tag: unstable
          - variant: shell
            tag: unstable-shell
    name: Publish ${{ matrix.variant }} image
    needs: [build-packages]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set GitHub vars
        id: github
        uses: ./.github/actions/github

      - name: Login to GitHub registry
        uses: docker/login-action@v3
        id: login-to-github
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Login to DockerHub registry
        uses: docker/login-action@v3
        id: login-to-docker-hub
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Write Melange Public Key
        id: melange-public-key
        shell: bash
        env:
          PUBLIC_KEY_BASE64: ${{ vars.MELANGE_PUBLIC_KEY_BASE64 }}
        run: |
          mkdir -p ${{ runner.temp }}/packages
          echo -n "$PUBLIC_KEY_BASE64" | base64 -d > ${{ runner.temp }}/packages/melange.rsa.pub

      - name: Download aarch64 packages
        uses: actions/download-artifact@v4
        with:
          name: packages-aarch64
          path: ${{ runner.temp }}/packages/aarch64

      - name: Download x86_64 packages
        uses: actions/download-artifact@v4
        with:
          name: packages-x86_64
          path: ${{ runner.temp }}/packages/x86_64

      - name: Publish image
        id: publish
        uses: ./.github/actions/apko/publish
        with:
          config: 'apko/${{ matrix.variant }}.yaml'
          tag: '${{ steps.github.outputs.repository }}:${{ matrix.tag }}'
          repository-append: ${{ runner.temp }}/packages
          keyring-append: ${{ runner.temp }}/packages/melange.rsa.pub
          sbom-path: ${{ runner.temp }}/sbom
          dockerhub-username: ${{ vars.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
          dagger-version: ${{ env.DAGGER_VERSION }}
          dagger-cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

      - name: Scan vulnerabilities
        id: scan
        uses: ./.github/actions/scan
        with:
          image: 'ghcr.io/${{ steps.github.outputs.repository }}:${{ matrix.tag }}'

      - name: Sign and Attest image
        id: sign
        uses: ./.github/actions/cosign/sign
        with:
          image: '${{ steps.github.outputs.repository }}'
          tag: ${{ matrix.tag }}
          sbom-path: ${{ runner.temp }}/sbom

  publish-helm-chart:
    name: Publish Helm Chart
    needs: [publish-images]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set GitHub vars
        id: github
        uses: ./.github/actions/github

      - name: Test Helm chart
        uses: ./.github/actions/helm/test
        with:
          dagger-version: ${{ env.DAGGER_VERSION }}
          dagger-cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}

      - name: Publish Helm chart
        uses: ./.github/actions/helm/publish
        with:
          registry: ghcr.io/${{ steps.github.outputs.repository }}/helm
          version: '0.0.0'
          app-version: 'unstable'
          dagger-version: ${{ env.DAGGER_VERSION }}
          dagger-cloud-token: ${{ secrets.DAGGER_CLOUD_TOKEN }}
