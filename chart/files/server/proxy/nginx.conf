{{- $releaseNamespace := .Release.Namespace -}}
{{- $clusterDomain := .Values.clusterDomain -}}
{{- $fullname := include "ggbridge.fullname" . -}}
{{- $serverFullname := include "ggbridge.server.fullname" . -}}
{{- $proxyFullname := include "ggbridge.proxy.fullname" . -}}

load_module "/usr/lib/nginx/modules/ngx_stream_module.so";

worker_processes 1;
error_log  stderr  notice;
events {
    worker_connections 1024;
}

stream {
    log_format main '$remote_addr [$time_local] '
                    '$protocol $status $bytes_sent $bytes_received '
                    '$session_time "$upstream_addr" '
                      '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';

    access_log /dev/stdout main;

    resolver {{ printf "kube-dns.kube-system.svc.%s" $clusterDomain }} valid=30s;
    resolver_timeout 5s;

    upstream backend {
        least_conn;
        {{- range $index := until (include "ggbridge.server.deploymentCount" . | int) }}
          {{- $indexServerProxyFullname := printf "%s-proxy-%d" $serverFullname ($index | int) }}
        {{ printf "server %s:%d;" (printf "%s.%s.svc.%s" $indexServerProxyFullname $releaseNamespace $clusterDomain) ($.Values.server.proxy.service.ports.socks.port | int) }}
        {{- end }}
    }

    server {
        listen {{ .Values.server.proxy.service.ports.socks.containerPort }};
        proxy_pass backend;
        proxy_timeout 5s;
        proxy_connect_timeout 5s;
    }
}
